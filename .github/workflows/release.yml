# Terraform Provider release workflow.
name: Release

# This GitHub action creates a release when a tag that matches the pattern
# "v*" (e.g. v0.1.0) is created.
on:
  push:
    tags:
      - 'v*'

# Releases need permissions to read and write the repository contents.
# GitHub considers creating releases and uploading assets as writing contents.
permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          # Allow goreleaser to access older tag information.
          fetch-depth: 0
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        id: import_gpg
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2
      - name: Generate SPDX SBOM
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          syft scan dir:. -o spdx-json=terraform-provider-iosxe_${VERSION}_sbom.spdx.json \
            --source-name terraform-provider-iosxe \
            --source-version ${VERSION}
      - name: Generate CycloneDX SBOM
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          syft scan dir:. -o cyclonedx-json=terraform-provider-iosxe_${VERSION}_sbom.cyclonedx.json \
            --source-name terraform-provider-iosxe \
            --source-version ${VERSION}
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@ec59f474b9834571250b370d4735c50f8e2d1e29 # v7.0.0
        with:
          args: release --clean
        env:
          # GitHub sets the GITHUB_TOKEN secret automatically.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
      - name: Upload SBOM artifacts for repo update
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sbom-files
          path: |
            terraform-provider-iosxe_*_sbom.spdx.json
            terraform-provider-iosxe_*_sbom.cyclonedx.json
          retention-days: 1

  update-sbom-in-repo:
    needs: goreleaser
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: main
          fetch-depth: 1
      - name: Download SBOM artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sbom-files
      - name: Update SBOM in repository
        run: |
          VERSION=${GITHUB_REF#refs/tags/}

          # Create version-specific directory
          mkdir -p sbom/${VERSION}

          # Copy SBOM files to version-specific directory
          cp terraform-provider-iosxe_${VERSION}_sbom.spdx.json sbom/${VERSION}/sbom.spdx.json
          cp terraform-provider-iosxe_${VERSION}_sbom.cyclonedx.json sbom/${VERSION}/sbom.cyclonedx.json

          echo "✓ Created sbom/${VERSION}/ with SBOM files"

          # Also update sbom/latest/ for convenience
          cp sbom/${VERSION}/sbom.spdx.json sbom/latest/sbom.spdx.json
          cp sbom/${VERSION}/sbom.cyclonedx.json sbom/latest/sbom.cyclonedx.json

          # Get Syft version from the SBOM file itself (contains tool metadata)
          SYFT_VERSION=$(jq -r '.creationInfo.creators[1]' sbom/latest/sbom.spdx.json | sed 's/Tool: syft-/v/')

          # Update sbom/latest/README.md with version information
          awk -v ver="${VERSION}" '/^\*\*Provider Version\*\*:/ {print "**Provider Version**: " ver; next} {print}' sbom/latest/README.md > sbom/latest/README.md.tmp && mv sbom/latest/README.md.tmp sbom/latest/README.md
          awk -v date="$(date -u +%Y-%m-%d)" '/^\*\*Generated\*\*:/ {print "**Generated**: " date; next} {print}' sbom/latest/README.md > sbom/latest/README.md.tmp && mv sbom/latest/README.md.tmp sbom/latest/README.md
          awk -v syft="${SYFT_VERSION}" '/^\*\*Syft Version\*\*:/ {print "**Syft Version**: " syft; next} {print}' sbom/latest/README.md > sbom/latest/README.md.tmp && mv sbom/latest/README.md.tmp sbom/latest/README.md

          echo "✓ Updated sbom/latest/README.md"
      - name: Commit and push SBOM updates
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sbom/
          git commit -m "Add SBOM for ${VERSION}

          - Created sbom/${VERSION}/ with version-specific SBOM files
          - Updated sbom/latest/ to reference ${VERSION}

          Generated by GitHub Actions release workflow."
          git push origin main
